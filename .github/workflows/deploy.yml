name: Deploy Medusa to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'

    - name: Install Dependencies
      run: yarn install --frozen-lockfile

    - name: Build Medusa (Admin + Backend)
      run: yarn build
      env:
        # Add necessary build env vars here if needed
        NODE_ENV: production

    - name: Remove dev dependencies to save space
      run: yarn install --production --ignore-scripts --prefer-offline

    - name: Compress Build Artifacts
      run: tar -czf build.tar.gz .next .medusa dist package.json yarn.lock medusa-config.js public node_modules

    - name: Copy Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "build.tar.gz"
        target: "/var/www/medusa"

    - name: Deploy on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /var/www/medusa
          # Extract files
          tar -xzf build.tar.gz
          rm build.tar.gz
          
          # Run Migrations (Optional: safer to run manually first time)
          # npx medusa migrations run
          
          # Start/Restart App with PM2
          pm2 describe medusa > /dev/null
          if [ $? -eq 0 ]; then
            pm2 reload medusa
          else
            # Start backend (adjust script if using custom start command)
            pm2 start npm --name "medusa" -- start
          fi
          pm2 save