name: Deploy Medusa to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'

    - name: Enable Corepack (Yarn 4)
      run: corepack enable

    - name: Install Dependencies
      run: yarn install --immutable

    - name: Build Medusa (Admin + Backend)
      run: yarn build
      env:
        NODE_ENV: production

    # âŒ Remove this step, it breaks a Berry install
    # - name: Remove dev dependencies to save space
    #   run: yarn install --production --ignore-scripts --prefer-offline

    - name: Compress Build Artifacts
      run: |
        tar -czf build.tar.gz \
          .medusa \
          package.json \
          yarn.lock \
          medusa-config.js \
          .yarn \
          .pnp.cjs

    - name: Copy Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "build.tar.gz"
        target: "/var/www/medusa"

    - name: Deploy on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /var/www/medusa

          # Extract files
          tar -xzf build.tar.gz
          rm build.tar.gz

          # Ensure Corepack/Yarn 4 on EC2
          corepack enable

          cd .medusa/server

          # Install prod deps for the built server
          yarn install --immutable

          # Run migrations (predeploy)
          yarn predeploy

          # Start/Restart App with PM2 (server mode)
          pm2 describe aroha-server > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            pm2 reload aroha-server
          else
            pm2 start yarn --name "aroha-server" -- start --cwd /var/www/medusa/.medusa/server
          fi

          pm2 save
